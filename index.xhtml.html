<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Gerador de Fotos Polaroid ‚Äî Moldura Personaliz√°vel</title>
<style>
  body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial; padding:20px; background:#f6f7fb; color:#111}
  .panel{max-width:1100px;margin:0 auto;background:#fff;padding:16px;border-radius:8px;box-shadow:0 6px 20px rgba(0,0,0,.06)}
  h1{margin:0 0 12px;font-size:22px}
  .row{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px}
  input[type=file]{display:block}
  label{font-size:13px}
  canvas{background:#ddd;border:1px solid #ccc;max-width:100%;border-radius:6px}
  .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .btn{padding:8px 12px;border-radius:6px;border:none;background:#2563eb;color:#fff;cursor:pointer}
  .btn.secondary{background:#6b7280}
  .small{font-size:13px;padding:6px 8px}
  .info{font-size:13px;color:#444}
  .range{width:180px}
  .gallery{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:16px}
  .thumb{background:#fafafa;padding:8px;border-radius:8px;text-align:center;box-shadow:0 2px 6px rgba(0,0,0,.08)}
  .thumb canvas{width:100%;height:auto}
</style>
</head>
<body>
<div class="panel">
  <h1>Gerador de Fotos Polaroid ‚Äî Moldura Personaliz√°vel</h1>

  <div class="row">
    <div>
      <label>1) Escolher imagens (v√°rias permitidas)</label><br>
      <input id="file" type="file" accept="image/*" multiple>
    </div>
    <div>
      <label>2) DPI (resolu√ß√£o de impress√£o)</label><br>
      <select id="dpi">
        <option value="150">150 DPI</option>
        <option value="300" selected>300 DPI (recomendado)</option>
        <option value="600">600 DPI</option>
      </select>
    </div>
    <div>
      <label>3) Tamanho externo (corte)</label><br>
      <select id="size">
        <option value="62x90" selected>62 mm √ó 90 mm (Padr√£o)</option>
        <option value="58x86">58 mm √ó 86 mm (Mini)</option>
        <option value="64x97">64 mm √ó 97 mm (Wide)</option>
        <option value="70x100">70 mm √ó 100 mm (Grande)</option>
      </select>
    </div>
    <div>
      <label>4) Estilo</label><br>
      <select id="style">
        <option value="natural">Natural</option>
        <option value="vintage">Vintage</option>
        <option value="bw">Preto e branco</option>
        <option value="manual">Manual (R/G/B)</option>
      </select>
    </div>
  </div>

  <div class="row controls">
    <label>Tint (R/G/B):</label>
    <input id="r" class="range" type="range" min="0" max="255" value="0">
    <input id="g" class="range" type="range" min="0" max="255" value="0">
    <input id="b" class="range" type="range" min="0" max="255" value="0">
    <span class="info" id="rgbVal">0,0,0</span>
  </div>

  <div class="row">
    <button id="generate" class="btn">Gerar Fotos</button>
    <button id="downloadAll" class="btn secondary">Baixar Todas (ZIP)</button>
    <button id="generatePDF" class="btn small">Gerar Folha A4 (PDF)</button>
    <button id="reset" class="btn small">Resetar</button>
    <div style="margin-left:auto" class="info">√Årea da foto: 55√ó72 mm (fixa)</div>
  </div>

  <div id="gallery" class="gallery"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
const { jsPDF } = window.jspdf;
const fileInput=document.getElementById('file');
const gallery=document.getElementById('gallery');
const dpiSelect=document.getElementById('dpi');
const styleSelect=document.getElementById('style');
const rSlider=document.getElementById('r');
const gSlider=document.getElementById('g');
const bSlider=document.getElementById('b');
const rgbVal=document.getElementById('rgbVal');
const generateBtn=document.getElementById('generate');
const resetBtn=document.getElementById('reset');
const downloadAllBtn=document.getElementById('downloadAll');
const sizeSelect=document.getElementById('size');
const generatePDFBtn=document.getElementById('generatePDF');

// Medidas fixas da √°rea interna da foto
const PHOTO_W=55;
const PHOTO_H=72;
const MARGIN_LR=3.3;
const MARGIN_TOP=3.3;

function mmToIn(mm){ return mm/25.4; }
function pxFor(mm,dpi){ return Math.round(mmToIn(mm)*dpi); }

function updateRGB(){ rgbVal.textContent=`${rSlider.value},${gSlider.value},${bSlider.value}` }
rSlider.oninput=gSlider.oninput=bSlider.oninput=updateRGB; updateRGB();

function loadImage(src){
  return new Promise((res,rej)=>{
    const img=new Image();
    img.onload=()=>res(img);
    img.onerror=rej;
    img.src=src;
  });
}

function getCutSize(){
  const val=sizeSelect.value.split('x');
  return {W:+val[0],H:+val[1]};
}

function createFramedCanvas(img,dpi,cut){
  const W=pxFor(cut.W,dpi);
  const H=pxFor(cut.H,dpi);
  const photoW=pxFor(PHOTO_W,dpi);
  const photoH=pxFor(PHOTO_H,dpi);
  const marginLR=pxFor(MARGIN_LR,dpi);
  const marginTop=pxFor(MARGIN_TOP,dpi);

  const canvas=document.createElement('canvas');
  canvas.width=W; canvas.height=H;
  const ctx=canvas.getContext('2d');
  ctx.fillStyle='#fff';
  ctx.fillRect(0,0,W,H);

  const x=marginLR;
  const y=marginTop;

  const frame=document.createElement('canvas');
  frame.width=photoW;
  frame.height=photoH;
  const fctx=frame.getContext('2d');

  const imgRatio=img.width/img.height;
  const areaRatio=photoW/photoH;
  let drawW,drawH,offX=0,offY=0;
  if(imgRatio>areaRatio){
    drawH=photoH;
    drawW=Math.round(photoH*imgRatio);
    offX=Math.round((photoW-drawW)/2);
  }else{
    drawW=photoW;
    drawH=Math.round(photoW/imgRatio);
    offY=Math.round((photoH-drawH)/2);
  }
  fctx.drawImage(img,offX,offY,drawW,drawH);

  const id=fctx.getImageData(0,0,photoW,photoH);
  const data=id.data;
  const style=styleSelect.value;
  if(style==='bw'){
    for(let i=0;i<data.length;i+=4){
      const v=0.3*data[i]+0.59*data[i+1]+0.11*data[i+2];
      data[i]=data[i+1]=data[i+2]=v;
    }
  }else if(style==='vintage'){
    for(let i=0;i<data.length;i+=4){
      data[i]=Math.min(255,data[i]+10);
      data[i+2]=Math.max(0,data[i+2]-6);
    }
  }else if(style==='manual'){
    const rt=+rSlider.value,gt=+gSlider.value,bt=+bSlider.value,alpha=0.25;
    for(let i=0;i<data.length;i+=4){
      data[i]=Math.round((1-alpha)*data[i]+alpha*rt);
      data[i+1]=Math.round((1-alpha)*data[i+1]+alpha*gt);
      data[i+2]=Math.round((1-alpha)*data[i+2]+alpha*bt);
    }
  }
  fctx.putImageData(id,0,0);

  ctx.drawImage(frame,x,y,photoW,photoH);
  return canvas;
}

generateBtn.onclick=async()=>{
  gallery.innerHTML='';
  const files=[...fileInput.files];
  if(!files.length) return alert('Selecione pelo menos uma imagem!');
  const dpi=parseInt(dpiSelect.value,10);
  const cut=getCutSize();

  for(const f of files){
    const img=await loadImage(URL.createObjectURL(f));
    const c=createFramedCanvas(img,dpi,cut);
    const thumb=document.createElement('div');
    thumb.className='thumb';
    thumb.appendChild(c);

    const btn=document.createElement('button');
    btn.className='btn small';
    btn.textContent='Baixar';
    btn.onclick=()=>{
      c.toBlob(blob=>{
        const a=document.createElement('a');
        a.href=URL.createObjectURL(blob);
        a.download=`${f.name.replace(/\.[^/.]+$/,'')}_${cut.W}x${cut.H}mm.png`;
        a.click();
      });
    };
    thumb.appendChild(document.createElement('br'));
    thumb.appendChild(btn);
    gallery.appendChild(thumb);
  }
  alert(`Fotos geradas com moldura ${cut.W}√ó${cut.H} mm e foto interna 55√ó72 mm.`);
};

downloadAllBtn.onclick=async()=>{
  const canvases=gallery.querySelectorAll('canvas');
  if(!canvases.length) return alert('Nenhuma imagem gerada.');
  const zip=new JSZip(); let i=1;
  for(const c of canvases){
    const blob=await new Promise(r=>c.toBlob(r,'image/png'));
    zip.file(`foto_${i}.png`,blob); i++;
  }
  const content=await zip.generateAsync({type:'blob'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(content);
  a.download='fotos_polaroid.zip';
  a.click();
};

resetBtn.onclick=()=>{
  fileInput.value=''; gallery.innerHTML='';
  rSlider.value=gSlider.value=bSlider.value=0;
  styleSelect.value='natural'; updateRGB();
  alert('Sistema resetado.');
};

// üÜï Gerar PDF com linhas de corte
generatePDFBtn.onclick=async()=>{
  const canvases=gallery.querySelectorAll('canvas');
  if(!canvases.length) return alert('Nenhuma imagem gerada.');

  const cut=getCutSize();
  const pdf=new jsPDF({unit:'mm',format:'a4'});
  const pageW=210, pageH=297;
  const photoW=cut.W, photoH=cut.H;
  const margin=5;
  const spacing=3;

  let x=margin, y=margin;
  for(let i=0;i<canvases.length;i++){
    const imgData=canvases[i].toDataURL('image/jpeg',1);
    if(x+photoW>pageW-margin){
      x=margin;
      y+=photoH+spacing;
    }
    if(y+photoH>pageH-margin){
      pdf.addPage();
      x=margin; y=margin;
    }

    pdf.addImage(imgData,'JPEG',x,y,photoW,photoH);

    // linhas-guia de corte cinza claro
    pdf.setDrawColor(180);
    pdf.setLineWidth(0.1);
    pdf.rect(x,y,photoW,photoH);

    x+=photoW+spacing;
  }

  pdf.save('fotos_polaroid_guia.pdf');
};
</script>
</body>
</html>
